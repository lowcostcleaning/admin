<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lowcost Cleaning ‚Äî –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç—É—Å–æ–≤</title>
<style>
  :root{
    --bg:#f5f5f7;
    --card:#ffffff;
    --muted:#6e6e73;
    --text:#111;
    --line:#e5e5ea;
    --green:#34c759;
    --red:#ff3b30;
    --blue:#0a84ff;
    --radius:16px;
    --shadow:0 12px 30px rgba(0,0,0,0.06);
  }
  *{box-sizing:border-box}
  body{
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Roboto,system-ui,sans-serif;
    background:var(--bg); color:var(--text); margin:0; padding:24px;
    display:flex; flex-direction:column; align-items:center;
  }
  header{width:min(980px,94%); margin:0 auto 18px;}
  h1{margin:0 0 6px; font-size:28px; letter-spacing:-.3px; font-weight:700;}
  p.lead{margin:0; color:var(--muted); font-size:15px}
  .shell{width:min(980px,94%); background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px;}
  .topbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .tabs{display:flex; gap:8px; background:#f8f8f8; padding:6px; border-radius:12px; border:1px solid var(--line)}
  .tab{padding:10px 14px; border-radius:10px; cursor:pointer; user-select:none; color:#111}
  .tab.active{background:#111; color:#fff}
  .hooks{margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .hook-wrap{display:flex; gap:6px; align-items:center}
  .hook-wrap label{font-size:12px; color:var(--muted)}
  input.webhook{width:260px; max-width:64vw; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#fff; font-size:14px}
  button.savehooks{padding:10px 14px; border-radius:12px; border:none; background:#111; color:#fff; cursor:pointer}
  .note{color:var(--muted); font-size:13px; margin:10px 2px}
  .table-wrap{overflow:auto; border:1px solid var(--line); border-radius:12px}
  table{width:100%; border-collapse:collapse; min-width:520px}
  thead th{position:sticky; top:0; background:#fafafa; color:#111; font-weight:600; font-size:14px; text-align:left; border-bottom:1px solid var(--line); padding:12px 12px}
  tbody td{border-bottom:1px solid #f0f0f0; padding:12px 12px; font-size:14px; vertical-align:middle}
  .row-controls{white-space:nowrap}
  select.status{padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:#fff; font-size:14px}
  button.row-save{padding:8px 12px; border-radius:10px; border:none; background:#111; color:#fff; cursor:pointer}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); color:var(--muted)}
  .toast{position:fixed; right:20px; top:20px; background:#111; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; transform:translateY(-6px); transition:all .25s; z-index:1000}
  .toast.show{opacity:1; transform:translateY(0)}
  .legend{display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-size:12px; color:var(--muted)}
  .legend .dot{width:8px; height:8px; border-radius:50%}
  .g{background:var(--green)} .r{background:var(--red)} .b{background:var(--blue)}
  .login-overlay{
    position:fixed; inset:0; background:linear-gradient(180deg,#f7f7f9, #ececf1);
    display:flex; align-items:center; justify-content:center; z-index:2000;
  }
  .login-card{
    width:min(420px,90%); background:#fff; border-radius:20px; padding:22px 20px 18px;
    box-shadow:0 20px 50px rgba(0,0,0,.08); border:1px solid var(--line); text-align:center;
    animation:pop .18s ease-out;
  }
  .login-card h2{margin:0 0 8px; font-size:22px}
  .login-card p{margin:0 0 14px; color:var(--muted)}
  .login-row{display:flex; gap:8px; margin-top:8px; justify-content:center}
  .login-input{flex:1; padding:12px 14px; border-radius:12px; border:1px solid var(--line); font-size:16px}
  .login-btn{padding:12px 16px; border-radius:12px; border:none; background:#111; color:#fff; font-size:16px; cursor:pointer}
  @keyframes pop {from{transform:scale(.98); opacity:.5} to{transform:scale(1); opacity:1}}
  @media (max-width:720px){
    body{padding:16px}
    .hooks{margin-left:0}
    input.webhook{width:200px}
    thead th, tbody td{padding:10px}
    .tab{padding:8px 12px}
  }
</style>
</head>
<body>
  <!-- LOGIN OVERLAY -->
  <div id="login" class="login-overlay" style="display:none">
    <div class="login-card">
      <h2>Lowcost Cleaning</h2>
      <p>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</p>
      <div class="login-row">
        <input id="pass" class="login-input" type="password" inputmode="numeric" placeholder="–ü–∞—Ä–æ–ª—å" />
        <button id="enter" class="login-btn">–í–æ–π—Ç–∏</button>
      </div>
      <p class="note" style="margin-top:10px">–ü–æ–¥—Å–∫–∞–∑–∫–∞: 4 —Ü–∏—Ñ—Ä—ã üòâ</p>
    </div>
  </div>

  <header>
    <h1>Lowcost Cleaning ‚Äî –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç—É—Å–æ–≤</h1>
    <p class="lead">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞—è–≤–æ–∫ —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ –≤–∞—à–∏ –≤–µ–±—Ö—É–∫–∏ (n8n).</p>
  </header>

  <div class="shell">
    <div class="topbar">
      <div class="tabs">
        <div class="tab active" data-sheet="–ï–≤–≥–µ–Ω—É–±–æ—Ä–∫–∏">üè† –ï–≤–≥–µ–Ω—É–±–æ—Ä–∫–∏</div>
        <div class="tab" data-sheet="–•–∏–º—á–∏—Å—Ç–∫–∞">üß∫ –•–∏–º—á–∏—Å—Ç–∫–∞</div>
        <div class="tab" data-sheet="–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã">üè¢ –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã</div>
      </div>

      <div class="hooks">
        <div class="hook-wrap">
          <label for="wh-evg">–ï–≤–≥–µ–Ω—É–±–æ—Ä–∫–∏</label>
          <input id="wh-evg" class="webhook" placeholder="https://... (–≤–µ–±—Ö—É–∫)" />
        </div>
        <div class="hook-wrap">
          <label for="wh-chem">–•–∏–º—á–∏—Å—Ç–∫–∞</label>
          <input id="wh-chem" class="webhook" placeholder="https://... (–≤–µ–±—Ö—É–∫)" />
        </div>
        <div class="hook-wrap">
          <label for="wh-apts">–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã</label>
          <input id="wh-apts" class="webhook" placeholder="https://... (–≤–µ–±—Ö—É–∫)" />
        </div>
        <button class="savehooks" id="saveHooksBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>

    <div class="note">
      –ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è. –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ ¬´–°—Ç–∞—Ç—É—Å¬ª.
      <span class="legend" style="margin-left:8px">
        <span class="dot g"></span> —Å–≤–æ–±–æ–¥–Ω–æ
        <span class="dot b"></span> –æ–∂–∏–¥–∞–Ω–∏–µ
        <span class="dot r"></span> –∑–∞–Ω—è—Ç–æ / –æ—Ç–∫–∞–∑
      </span>
    </div>

    <div class="table-wrap" id="tableWrap">
      <table id="grid"><thead></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="toast" class="toast">–ì–æ—Ç–æ–≤–æ</div>

<script>
/* ===================== CONFIG ===================== */
const PASSCODE = "1234"; // –ø–æ–º–µ–Ω—è–µ—Ç–µ –ø–æ–∑–∂–µ
const GIDS = {
  "–ï–≤–≥–µ–Ω—É–±–æ—Ä–∫–∏":"0",
  "–•–∏–º—á–∏—Å—Ç–∫–∞":"591986483",
  "–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã":"1636464154"
};
const BASE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS8zb-CjwcHeTuOYB5iT5jz5RdMPaz0_BrTT6E1jPtaXfSbh7O1xykOE5WI92idU6A-SZ2GLzdcgtMU/pub?gid=";

// localStorage keys for webhooks
const WH_KEYS = {
  "–ï–≤–≥–µ–Ω—É–±–æ—Ä–∫–∏":"wh_evg",
  "–•–∏–º—á–∏—Å—Ç–∫–∞":"wh_chem",
  "–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã":"wh_apts",
};

/* ===================== UI ELEMENTS ===================== */
const login = document.getElementById("login");
const pass = document.getElementById("pass");
const enter = document.getElementById("enter");
const toast = document.getElementById("toast");
const grid = document.getElementById("grid");
const thead = grid.querySelector("thead");
const tbody = grid.querySelector("tbody");
const saveHooksBtn = document.getElementById("saveHooksBtn");

const whInputs = {
  "–ï–≤–≥–µ–Ω—É–±–æ—Ä–∫–∏": document.getElementById("wh-evg"),
  "–•–∏–º—á–∏—Å—Ç–∫–∞": document.getElementById("wh-chem"),
  "–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã": document.getElementById("wh-apts"),
};

let activeSheet = "–ï–≤–≥–µ–Ω—É–±–æ—Ä–∫–∏";
let cachedRows = []; // raw CSV rows
let headerMap = {};  // column name -> index

/* ===================== LOGIN ===================== */
function showLoginIfNeeded(){
  if (sessionStorage.getItem("evg_admin_ok")==="1") return;
  login.style.display = "flex";
  pass.focus();
}
enter.addEventListener("click", doLogin);
pass.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
function doLogin(){
  if ((pass.value||"").trim() === PASSCODE){
    sessionStorage.setItem("evg_admin_ok","1");
    login.style.display = "none";
  } else {
    showToast("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
  }
}
showLoginIfNeeded();

/* ===================== HELPERS ===================== */
function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 2000);
}

function normalize(str){
  return (str||"").toString().trim().toLowerCase();
}

// try to parse simple CSV (no quoted commas expected)
function parseCsvText(txt){
  return txt.split("\n").map(row => row.split(",").map(c => c.trim().replace(/^"|"$/g,"")));
}

// build header map (case-insensitive)
function makeHeaderMap(header){
  const map = {};
  header.forEach((h,i)=>{
    const key = normalize(h);
    map[key]=i;
  });
  return map;
}

async function fetchCsv(gid){
  const url = `${BASE_CSV}${gid}&single=true&output=csv&nocache=${Date.now()}`;
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV");
  const txt = await res.text();
  return parseCsvText(txt);
}

/* ===================== SHEET LOADING + RENDER ===================== */
async function loadSheet(name){
  try{
    // load webhook inputs from storage (once per load for UX)
    for(const k in WH_KEYS){
      const v = localStorage.getItem(WH_KEYS[k]) || "";
      whInputs[k].value = v;
    }

    const gid = GIDS[name];
    const rows = await fetchCsv(gid);
    // clean empty lines
    const cleaned = rows.filter(r => r && r.length && r.some(x=>x!==""));
    cachedRows = cleaned;
    const header = cleaned[0] || [];
    headerMap = makeHeaderMap(header);

    renderTable(name);
  }catch(e){
    console.error(e);
    thead.innerHTML = "";
    tbody.innerHTML = `<tr><td style="padding:16px;color:#999">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</td></tr>`;
  }
}

function renderTable(sheet){
  // mapping for columns we need per sheet
  // we try to read fields by russian header names
  // –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∫–ª—é—á–∏: –¥–∞—Ç–∞, –≤—Ä–µ–º—è, —Å—Ç–∞—Ç—É—Å, –∞–¥—Ä–µ—Å, –∂–∫, –∫–æ–º–ø–ª–µ–∫—Å, –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç
  const H = headerMap;
  const rows = cachedRows.slice(1);

  // Build table head
  let headHtml = "<tr>";
  if(sheet==="–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã"){
    headHtml += "<th>–î–∞—Ç–∞</th><th>–í—Ä–µ–º—è</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ñ–ö</th><th>–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</th><th></th>";
  }else{
    headHtml += "<th>–î–∞—Ç–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ê–¥—Ä–µ—Å</th><th></th>";
  }
  headHtml += "</tr>";
  thead.innerHTML = headHtml;

  // Build body
  const statusOptions = ["—Å–≤–æ–±–æ–¥–Ω–æ","–∑–∞–Ω—è—Ç–æ","–æ–∂–∏–¥–∞–Ω–∏–µ","–æ—Ç–∫–∞–∑",""];
  let bodyHtml = "";

  rows.forEach((r, idx)=>{
    const rowIndex = idx + 2; // 1-based header +1

    const v = (keyList)=>{ // helper to get first found header index among aliases
      for(const key of keyList){
        const i = H[normalize(key)];
        if(i !== undefined) return (r[i]||"").trim();
      }
      return "";
    };

    const date = v(["–¥–∞—Ç–∞"]);
    const time = v(["–≤—Ä–µ–º—è"]);
    const status = normalize(v(["—Å—Ç–∞—Ç—É—Å"]));
    const address = v(["–∞–¥—Ä–µ—Å"]);
    const complex = v(["–∂–∫","–∫–æ–º–ø–ª–µ–∫—Å"]);
    const apartment = v(["–∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"]);

    // pick row color pill by status (for quick glance)
    let pillClass = "";
    if(status==="—Å–≤–æ–±–æ–¥–Ω–æ") pillClass = "g";
    else if(status==="–æ–∂–∏–¥–∞–Ω–∏–µ") pillClass = "b";
    else if(status==="–∑–∞–Ω—è—Ç–æ" || status==="–æ—Ç–∫–∞–∑") pillClass = "r";

    if(sheet==="–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã"){
      bodyHtml += `<tr data-row="${rowIndex}">
        <td>${date||"‚Äî"}</td>
        <td>${time||"‚Äî"}</td>
        <td>
          <div style="display:flex;align-items:center;gap:8px">
            <span class="dot ${pillClass}" style="width:8px;height:8px;border-radius:50%"></span>
            <select class="status">
              ${statusOptions.map(o=>`<option value="${o}" ${o===status?"selected":""}>${o||"‚Äî"}</option>`).join("")}
            </select>
          </div>
        </td>
        <td>${complex||"‚Äî"}</td>
        <td>${apartment||"‚Äî"}</td>
        <td class="row-controls"><button class="row-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></td>
      </tr>`;
    }else{
      bodyHtml += `<tr data-row="${rowIndex}">
        <td>${date||"‚Äî"}</td>
        <td>
          <div style="display:flex;align-items:center;gap:8px">
            <span class="dot ${pillClass}" style="width:8px;height:8px;border-radius:50%"></span>
            <select class="status">
              ${statusOptions.map(o=>`<option value="${o}" ${o===status?"selected":""}>${o||"‚Äî"}</option>`).join("")}
            </select>
          </div>
        </td>
        <td>${address||"‚Äî"}</td>
        <td class="row-controls"><button class="row-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></td>
      </tr>`;
    }
  });

  tbody.innerHTML = bodyHtml;

  // attach row handlers
  tbody.querySelectorAll(".row-save").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const tr = btn.closest("tr");
      const row = tr.dataset.row;
      const statusSel = tr.querySelector("select.status");
      const newStatus = (statusSel?.value || "").trim();

      // collect visible fields from row cells (as rendered)
      const tds = Array.from(tr.querySelectorAll("td"));
      let payload = { sheet, row, status: newStatus };

      if(sheet==="–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã"){
        payload.date = (tds[0]?.textContent || "").trim();
        payload.time = (tds[1]?.textContent || "").trim();
        payload.complex = (tds[3]?.textContent || "").trim();
        payload.apartment = (tds[4]?.textContent || "").trim();
      }else{
        payload.date = (tds[0]?.textContent || "").trim();
        payload.address = (tds[2]?.textContent || "").trim();
      }

      try{
        await sendWebhook(sheet, payload);
        showToast("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
      }catch(err){
        console.error(err);
        showToast("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏");
      }
    });
  });
}

/* ===================== WEBHOOKS ===================== */
saveHooksBtn.addEventListener("click", ()=>{
  for(const sheet in WH_KEYS){
    localStorage.setItem(WH_KEYS[sheet], (whInputs[sheet].value||"").trim());
  }
  showToast("–í–µ–±—Ö—É–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
});

async function sendWebhook(sheet, payload){
  const key = WH_KEYS[sheet];
  const url = (localStorage.getItem(key)||"").trim();
  if(!url) throw new Error("Webhook URL –Ω–µ —É–∫–∞–∑–∞–Ω –¥–ª—è –ª–∏—Å—Ç–∞: "+sheet);
  const qs = new URLSearchParams(payload).toString();
  const full = `${url}?${qs}`;
  const res = await fetch(full, { method:"GET", cache:"no-store" });
  if(!res.ok) throw new Error("HTTP "+res.status);
}

/* ===================== TABS ===================== */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    activeSheet = tab.dataset.sheet;
    loadSheet(activeSheet);
  });
});

/* ===================== INIT ===================== */
loadSheet(activeSheet);
</script>
</body>
</html>
