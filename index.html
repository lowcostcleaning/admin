<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lowcost Cleaning ‚Äî –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç—É—Å–æ–≤</title>
<style>
  :root {
    --bg:#f6f6f6;
    --card:#fff;
    --muted:#666;
    --radius:14px;
    --shadow:0 8px 25px rgba(0,0,0,0.05);
  }

  body {
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Roboto,sans-serif;
    background:var(--bg);
    color:#111;
    margin:0;
    padding:32px;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  h1 {margin:0 0 8px;font-size:28px;}
  p.lead {margin:0 0 24px;color:var(--muted);}
  .tabs {display:flex;gap:10px;}
  .tab {
    padding:10px 16px;
    border-radius:12px;
    background:#fff;
    border:1px solid rgba(0,0,0,0.08);
    cursor:pointer;
    transition:.2s;
  }
  .tab.active {background:#111;color:#fff;}
  .card {
    width:min(900px,95%);
    background:var(--card);
    border-radius:16px;
    padding:18px;
    box-shadow:var(--shadow);
    margin-bottom:20px;
  }
  .controls {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    margin-bottom:16px;
  }
  .controls-right {
    margin-left:auto;
    display:flex;
    gap:8px;
    align-items:center;
  }
  input.webhook {
    width:360px;
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #ddd;
    font-size:14px;
  }
  button.save {
    padding:8px 12px;
    border-radius:10px;
    border:none;
    background:#111;
    color:#fff;
    cursor:pointer;
    transition:.2s;
  }
  button.save:hover {background:#333;}
  table {width:100%;border-collapse:collapse;}
  th, td {
    padding:10px 12px;
    text-align:left;
    border-bottom:1px solid #f0f0f0;
    font-size:15px;
  }
  th {background:#fafafa;font-weight:600;}
  select.status {
    padding:6px 10px;
    border-radius:10px;
    border:1px solid #ddd;
    font-size:14px;
  }
  .note {color:var(--muted);font-size:13px;margin-bottom:8px;}
  .toast {
    position:fixed;
    right:20px;
    top:20px;
    background:#111;
    color:#fff;
    padding:10px 14px;
    border-radius:10px;
    opacity:0;
    transform:translateY(-6px);
    transition:all .25s;
  }
  .toast.show {opacity:1;transform:translateY(0);}
  .loading {color:var(--muted);padding:24px;text-align:center;}
  td button.save-row {
    background:#111;
    color:white;
    border:none;
    border-radius:8px;
    padding:6px 10px;
    cursor:pointer;
    font-size:13px;
    transition:.2s;
  }
  td button.save-row:hover {background:#333;}
  @media (max-width:700px) {
    input.webhook{width:100%;}
    .controls-right{flex-direction:column;align-items:flex-start;}
  }
</style>
</head>
<body>
  <h1>üìã –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç—É—Å–æ–≤ ‚Äî Lowcost Cleaning</h1>
  <p class="lead">–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç–∞—Ç—É—Å—ã —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ n8n.</p>

  <div class="card">
    <div class="controls">
      <div class="tabs">
        <div class="tab active" data-sheet="–ì–ª–∞–≤–Ω—ã–π">üè† –ï–≤–≥–µ–Ω—É–±–æ—Ä–∫–∏</div>
        <div class="tab" data-sheet="–•–∏–º—á–∏—Å—Ç–∫–∞">üß∫ –•–∏–º—á–∏—Å—Ç–∫–∞</div>
        <div class="tab" data-sheet="–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã">üè¢ –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã</div>
      </div>
      <div class="controls-right">
        <span style="font-size:13px;color:#666;">Webhook:</span>
        <input id="webhookInput" class="webhook" placeholder="URL –¥–ª—è —ç—Ç–æ–≥–æ –ª–∏—Å—Ç–∞" />
        <button id="saveWebhook" class="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>

    <div id="content"><p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>
  </div>

  <div id="toast" class="toast">–ì–æ—Ç–æ–≤–æ</div>

<script>
const WEBHOOK_KEYS = {
  "–ì–ª–∞–≤–Ω—ã–π": "lc_webhook_main",
  "–•–∏–º—á–∏—Å—Ç–∫–∞": "lc_webhook_clean",
  "–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã": "lc_webhook_apart"
};

const GIDS = {
  "–ì–ª–∞–≤–Ω—ã–π": "0",
  "–•–∏–º—á–∏—Å—Ç–∫–∞": "591986483",
  "–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã": "1636464154"
};

const BASE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS8zb-CjwcHeTuOYB5iT5jz5RdMPaz0_BrTT6E1jPtaXfSbh7O1xykOE5WI92idU6A-SZ2GLzdcgtMU/pub?gid=";

let activeSheet = "–ì–ª–∞–≤–Ω—ã–π";
const content = document.getElementById("content");
const toast = document.getElementById("toast");
const webhookInput = document.getElementById("webhookInput");
const saveWebhook = document.getElementById("saveWebhook");

saveWebhook.addEventListener("click", () => {
  const key = WEBHOOK_KEYS[activeSheet];
  localStorage.setItem(key, webhookInput.value.trim());
  showToast(`Webhook –¥–ª—è "${activeSheet}" —Å–æ—Ö—Ä–∞–Ω—ë–Ω`);
});

document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    activeSheet = tab.dataset.sheet;
    loadWebhook();
    loadSheet(activeSheet);
  });
});

function loadWebhook(){
  const key = WEBHOOK_KEYS[activeSheet];
  webhookInput.value = localStorage.getItem(key) || "";
}

function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 2200);
}

async function fetchCsv(gid) {
  const url = `${BASE_CSV}${gid}&single=true&output=csv&nocache=${Date.now()}`;
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV");
  const text = await res.text();
  return text.split("\n").map(r => r.split(",").map(c => c.trim().replace(/^"|"$/g, "")));
}

async function loadSheet(sheetName) {
  content.innerHTML = `<p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ ${sheetName}...</p>`;
  try {
    const gid = GIDS[sheetName];
    const rows = await fetchCsv(gid);
    const data = rows.filter(r => r && r.length && r.some(cell => cell !== ""));
    const headers = data[0] || [];
    const body = data.slice(1);

    let visibleCols = [];
    if (sheetName === "–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã") visibleCols = ["–¥–∞—Ç–∞", "–≤—Ä–µ–º—è", "—Å—Ç–∞—Ç—É—Å", "–∂–∫", "–∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"];
    else visibleCols = ["–¥–∞—Ç–∞", "—Å—Ç–∞—Ç—É—Å", "–∞–¥—Ä–µ—Å"];

    const colIndexes = headers.map((h, i) => visibleCols.includes(h.toLowerCase()) ? i : -1).filter(i => i !== -1);

    let html = `<div class="note">–õ–∏—Å—Ç: <b>${sheetName}</b> ‚Äî —Å—Ç—Ä–æ–∫: ${body.length}</div>`;
    html += `<table><thead><tr>${colIndexes.map(i => `<th>${headers[i]}</th>`).join("")}<th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead><tbody>`;

    body.forEach((row, idx) => {
      const rowIndex = idx + 2;
      html += `<tr data-row="${rowIndex}">`;
      colIndexes.forEach(ci => {
        const h = (headers[ci] || "").toLowerCase();
        const cell = row[ci] || "";
        if (h.includes("—Å—Ç–∞—Ç—É—Å")) {
          const opts = ["—Å–≤–æ–±–æ–¥–Ω–æ", "–∑–∞–Ω—è—Ç–æ", "–æ–∂–∏–¥–∞–Ω–∏–µ", "–æ—Ç–∫–∞–∑", ""];
          html += `<td><select class="status" data-col="${ci}">
            ${opts.map(o => `<option value="${o}" ${o === cell.toLowerCase() ? "selected" : ""}>${o || "‚Äî"}</option>`).join("")}
          </select></td>`;
        } else html += `<td>${cell}</td>`;
      });
      html += `<td><button class="save-row">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></td></tr>`;
    });

    html += "</tbody></table>";
    content.innerHTML = html;

    document.querySelectorAll(".save-row").forEach(btn => {
      btn.addEventListener("click", async () => {
        const tr = btn.closest("tr");
        const row = tr.dataset.row;
        const statusSel = tr.querySelector("select.status");
        const newStatus = statusSel ? statusSel.value : "";
        const dateCell = tr.querySelector("td")?.textContent.trim() || "";
        try {
          await sendWebhook({
            sheet: activeSheet,
            row: row,
            date: dateCell,
            status: newStatus
          });
          showToast("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
        } catch (err) {
          console.error(err);
          showToast("‚ö†Ô∏è –û—à–∏–±–∫–∞");
        }
      });
    });

  } catch (err) {
    console.error(err);
    content.innerHTML = "<p class='loading'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>";
  }
}

async function sendWebhook(payload) {
  const key = WEBHOOK_KEYS[activeSheet];
  const baseUrl = (localStorage.getItem(key) || "").trim();
  if (!baseUrl) throw new Error("Webhook URL –Ω–µ —É–∫–∞–∑–∞–Ω");
  const params = new URLSearchParams(payload);
  const url = `${baseUrl}?${params.toString()}`;
  const res = await fetch(url, { method: "GET", cache: "no-store" });
  if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ " + res.status);
  return res;
}

loadWebhook();
loadSheet(activeSheet);
</script>
</body>
</html>
